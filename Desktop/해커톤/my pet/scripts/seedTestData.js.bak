/**
 * í…ŒìŠ¤íŠ¸ ê³„ì •ìš© ì‹œë“œ ë°ì´í„° ìƒì„± ìŠ¤í¬ë¦½íŠ¸
 * 
 * ì‚¬ìš©ë²•:
 *   node scripts/seedTestData.js <ë³´í˜¸ìUID> <ë³‘ì›UID>
 * 
 * ì˜ˆì‹œ:
 *   node scripts/seedTestData.js abc123 xyz789
 */

const admin = require('firebase-admin');
const path = require('path');

// Firebase Admin SDK ì´ˆê¸°í™”
const serviceAccount = require('../hospital-import/ai-factory-c6d58-firebase-adminsdk-fbsvc-1bdd11cb90.json');

admin.initializeApp({
  credential: admin.credential.cert(serviceAccount)
});

const db = admin.firestore();

/**
 * ë‚ ì§œ ìƒì„± í—¬í¼
 */
function getDate(daysAgo = 0) {
  const date = new Date();
  date.setDate(date.getDate() - daysAgo);
  return admin.firestore.Timestamp.fromDate(date);
}

/**
 * ë³´í˜¸ì ê³„ì • ì‹œë“œ ë°ì´í„° ìƒì„±
 */
async function seedGuardianData(guardianUid, guardianEmail) {
  console.log(`\nğŸ‘¤ ë³´í˜¸ì ê³„ì • ë°ì´í„° ìƒì„± ì‹œì‘: ${guardianEmail} (${guardianUid})\n`);

  try {
    // 1. ë°˜ë ¤ë™ë¬¼ ìƒì„±
    console.log('ğŸ¾ ë°˜ë ¤ë™ë¬¼ ìƒì„± ì¤‘...');
    
    const ì´ˆì½” = {
      userId: guardianUid,
      petName: 'ì´ˆì½”',
      species: 'dog',
      breed: 'ë§í‹°ì¦ˆ',
      gender: 'male',
      birthDate: getDate(365 * 3), // 3ì‚´
      neutered: true,
      weight: 3.5,
      createdAt: getDate(30),
      updatedAt: getDate(0)
    };
    const ì´ˆì½”Ref = await db.collection('pets').add(ì´ˆì½”);
    const ì´ˆì½”Id = ì´ˆì½”Ref.id;
    console.log(`   âœ… ì´ˆì½” ìƒì„± ì™„ë£Œ (ID: ${ì´ˆì½”Id})`);

    const ë‚˜ë¹„ = {
      userId: guardianUid,
      petName: 'ë‚˜ë¹„',
      species: 'cat',
      breed: 'í˜ë¥´ì‹œì•ˆ',
      gender: 'female',
      birthDate: getDate(365 * 2), // 2ì‚´
      neutered: true,
      weight: 4.2,
      createdAt: getDate(20),
      updatedAt: getDate(0)
    };
    const ë‚˜ë¹„Ref = await db.collection('pets').add(ë‚˜ë¹„);
    const ë‚˜ë¹„Id = ë‚˜ë¹„Ref.id;
    console.log(`   âœ… ë‚˜ë¹„ ìƒì„± ì™„ë£Œ (ID: ${ë‚˜ë¹„Id})`);

    // 2. AI ì§„ë‹¨ ê¸°ë¡ ìƒì„± (4ê°œ)
    console.log('\nğŸ¥ AI ì§„ë‹¨ ê¸°ë¡ ìƒì„± ì¤‘...');
    
    const diagnoses = [
      {
        userId: guardianUid,
        petId: ì´ˆì½”Id,
        petName: 'ì´ˆì½”',
        diagnosis: 'ê²½ë¯¸í•œ í”¼ë¶€ì—¼',
        description: 'ì´ˆì½”ëŠ” ê°€ë²¼ìš´ í”¼ë¶€ ì—¼ì¦ ì¦ìƒì„ ë³´ì´ê³  ìˆìŠµë‹ˆë‹¤. ê°€ë ¤ì›€ê³¼ ë°œì ì´ ê´€ì°°ë˜ë©°, ì•Œë ˆë¥´ê¸°ì„± ë°˜ì‘ì¼ ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤.',
        emergencyLevel: 'medium',
        triageLevel: 'medium',
        actions: [
          { type: 'home_care', title: 'ëª©ìš• ìì£¼ ê¸ˆì§€', description: 'ì¼ì£¼ì¼ì— 1íšŒ ì´í•˜ë¡œ ëª©ìš•' },
          { type: 'medication', title: 'í•­íˆìŠ¤íƒ€ë¯¼ì œ', description: 'ìˆ˜ì˜ì‚¬ ì²˜ë°©ì— ë”°ë¼ ë³µìš©' },
          { type: 'monitor', title: 'ì¦ìƒ ê´€ì°°', description: '3ì¼ ë‚´ ê°œì„ ë˜ì§€ ì•Šìœ¼ë©´ ë³‘ì› ë°©ë¬¸' }
        ],
        symptomTags: ['ê°€ë ¤ì›€', 'ë°œì ', 'íƒˆëª¨'],
        createdAt: getDate(5)
      },
      {
        userId: guardianUid,
        petId: ì´ˆì½”Id,
        petName: 'ì´ˆì½”',
        diagnosis: 'ì†Œí™”ë¶ˆëŸ‰',
        description: 'ì´ˆì½”ì˜ êµ¬í† ì™€ ì„¤ì‚¬ ì¦ìƒì´ ê´€ì°°ë©ë‹ˆë‹¤. ì‹ì´ ë³€í™”ë‚˜ ë¶€ì ì ˆí•œ ìŒì‹ ì„­ì·¨ë¡œ ì¸í•œ ì¼ì‹œì ì¸ ì†Œí™”ë¶ˆëŸ‰ìœ¼ë¡œ ë³´ì…ë‹ˆë‹¤.',
        emergencyLevel: 'low',
        triageLevel: 'low',
        actions: [
          { type: 'diet', title: 'ì‹ì´ ì¡°ì ˆ', description: '12ì‹œê°„ ê¸ˆì‹ í›„ ì†ŒëŸ‰ì”© ê¸‰ì—¬' },
          { type: 'hydration', title: 'ìˆ˜ë¶„ ì„­ì·¨', description: 'ì¶©ë¶„í•œ ë¬¼ ê³µê¸‰' }
        ],
        symptomTags: ['êµ¬í† ', 'ì„¤ì‚¬'],
        createdAt: getDate(10)
      },
      {
        userId: guardianUid,
        petId: ë‚˜ë¹„Id,
        petName: 'ë‚˜ë¹„',
        diagnosis: 'í˜¸í¡ê¸° ê°ì—¼ ì˜ì‹¬',
        description: 'ë‚˜ë¹„ì˜ ê¸°ì¹¨ê³¼ ì½§ë¬¼ ì¦ìƒì´ ì§€ì†ë˜ê³  ìˆìŠµë‹ˆë‹¤. ìƒë¶€ í˜¸í¡ê¸° ê°ì—¼ ê°€ëŠ¥ì„±ì´ ìˆì–´ ìˆ˜ì˜ì‚¬ ì§„ë£Œê°€ í•„ìš”í•©ë‹ˆë‹¤.',
        emergencyLevel: 'high',
        triageLevel: 'high',
        actions: [
          { type: 'hospital', title: 'ë³‘ì› ë°©ë¬¸', description: '24ì‹œê°„ ë‚´ ìˆ˜ì˜ì‚¬ ì§„ë£Œ ê¶Œì¥' },
          { type: 'monitor', title: 'í˜¸í¡ ìƒíƒœ ê´€ì°°', description: 'í˜¸í¡ ê³¤ë€ ì‹œ ì¦‰ì‹œ ì‘ê¸‰ì‹¤' }
        ],
        symptomTags: ['ê¸°ì¹¨', 'ì½§ë¬¼', 'í˜¸í¡ê³¤ë€'],
        createdAt: getDate(3)
      },
      {
        userId: guardianUid,
        petId: ë‚˜ë¹„Id,
        petName: 'ë‚˜ë¹„',
        diagnosis: 'ì¹˜ì•„ ë¬¸ì œ',
        description: 'ë‚˜ë¹„ì˜ ì‹ìš• ì €í•˜ì™€ ì¹¨ í˜ë¦¼ ì¦ìƒì´ ê´€ì°°ë©ë‹ˆë‹¤. ì¹˜ì•„ë‚˜ ì‡ëª¸ ë¬¸ì œì¼ ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤.',
        emergencyLevel: 'medium',
        triageLevel: 'medium',
        actions: [
          { type: 'hospital', title: 'ì¹˜ê³¼ ì§„ë£Œ', description: 'ì¼ì£¼ì¼ ë‚´ ì¹˜ê³¼ ê²€ì§„ ê¶Œì¥' },
          { type: 'diet', title: 'ë¶€ë“œëŸ¬ìš´ ìŒì‹', description: 'ê²½ì§ˆ ì‚¬ë£Œ ëŒ€ì‹  ìŠµì‹ ì‚¬ë£Œ ì œê³µ' }
        ],
        symptomTags: ['ì‹ìš•ì €í•˜', 'ì¹¨í˜ë¦¼'],
        createdAt: getDate(15)
      }
    ];

    for (const diagnosis of diagnoses) {
      await db.collection('diagnoses').add(diagnosis);
    }
    console.log(`   âœ… ì§„ë‹¨ ê¸°ë¡ 4ê°œ ìƒì„± ì™„ë£Œ`);

    // 3. ì¼ì¼ ì¼€ì–´ ë¡œê·¸ ìƒì„± (14ê°œ, 7ì¼ì¹˜)
    console.log('\nğŸ“ ì¼ì¼ ì¼€ì–´ ë¡œê·¸ ìƒì„± ì¤‘...');
    
    const careLogs = [];
    for (let day = 0; day < 7; day++) {
      // ì´ˆì½” ë¡œê·¸
      careLogs.push({
        userId: guardianUid,
        petId: ì´ˆì½”Id,
        petName: 'ì´ˆì½”',
        date: getDate(day),
        activities: [
          { type: 'meal', time: '08:00', note: 'ê±´ì‚¬ë£Œ 1ì»µ' },
          { type: 'walk', time: '10:00', note: 'ì‚°ì±… 30ë¶„' },
          { type: 'meal', time: '18:00', note: 'ê±´ì‚¬ë£Œ 1ì»µ' }
        ],
        notes: day === 0 ? 'í”¼ë¶€ ê°€ë ¤ì›€ ê´€ì°°ë¨' : null,
        createdAt: getDate(day)
      });

      // ë‚˜ë¹„ ë¡œê·¸
      careLogs.push({
        userId: guardianUid,
        petId: ë‚˜ë¹„Id,
        petName: 'ë‚˜ë¹„',
        date: getDate(day),
        activities: [
          { type: 'meal', time: '09:00', note: 'ìŠµì‹ ì‚¬ë£Œ 1ìº”' },
          { type: 'play', time: '15:00', note: 'ì¥ë‚œê° ë†€ì´' },
          { type: 'meal', time: '20:00', note: 'ìŠµì‹ ì‚¬ë£Œ 1ìº”' }
        ],
        notes: day === 2 ? 'ê¸°ì¹¨ ì¦ìƒ ì§€ì†' : null,
        createdAt: getDate(day)
      });
    }

    for (const log of careLogs) {
      await db.collection('dailyLogs').add(log);
    }
    console.log(`   âœ… ì¼€ì–´ ë¡œê·¸ 14ê°œ ìƒì„± ì™„ë£Œ`);

    console.log('\nâœ… ë³´í˜¸ì ê³„ì • ë°ì´í„° ìƒì„± ì™„ë£Œ!');
    return {
      success: true,
      pets: [ì´ˆì½”Id, ë‚˜ë¹„Id],
      diagnoses: 4,
      careLogs: 14
    };
  } catch (error) {
    console.error('âŒ ë³´í˜¸ì ë°ì´í„° ìƒì„± ì˜¤ë¥˜:', error);
    throw error;
  }
}

/**
 * ë³‘ì› ê³„ì • ì‹œë“œ ë°ì´í„° ìƒì„±
 */
async function seedClinicData(clinicUid, clinicEmail) {
  console.log(`\nğŸ¥ ë³‘ì› ê³„ì • ë°ì´í„° ìƒì„± ì‹œì‘: ${clinicEmail} (${clinicUid})\n`);

  try {
    // 1. ë³‘ì› ì •ë³´ í™•ì¸/ìƒì„±
    console.log('ğŸ¥ ë³‘ì› ì •ë³´ í™•ì¸ ì¤‘...');
    
    const userDoc = await db.collection('users').doc(clinicUid).get();
    let clinicId = null;
    
    if (userDoc.exists()) {
      const userData = userDoc.data();
      clinicId = userData.defaultClinicId;
      
      if (clinicId) {
        const clinicDoc = await db.collection('clinics').doc(clinicId).get();
        if (clinicDoc.exists()) {
          console.log(`   âœ… ê¸°ì¡´ ë³‘ì› ì •ë³´ ì‚¬ìš©: ${clinicDoc.data().name}`);
        } else {
          clinicId = null;
        }
      }
    }

    if (!clinicId) {
      // ìƒˆ ë³‘ì› ìƒì„±
      const clinicData = {
        name: 'í–‰ë³µë™ë¬¼ë³‘ì›',
        address: 'ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123',
        phone: '02-1234-5678',
        ownerUserId: clinicUid,
        createdAt: getDate(60),
        updatedAt: getDate(0)
      };
      const clinicRef = await db.collection('clinics').add(clinicData);
      clinicId = clinicRef.id;
      
      // ì‚¬ìš©ì ì •ë³´ ì—…ë°ì´íŠ¸
      await db.collection('users').doc(clinicUid).update({
        defaultClinicId: clinicId,
        userMode: 'clinic',
        roles: ['clinic_owner']
      });
      
      console.log(`   âœ… ìƒˆ ë³‘ì› ìƒì„± ì™„ë£Œ: í–‰ë³µë™ë¬¼ë³‘ì› (ID: ${clinicId})`);
    }

    // 2. ì˜ˆì•½ ê¸°ë¡ ìƒì„± (50ê°œ)
    console.log('\nğŸ“… ì˜ˆì•½ ê¸°ë¡ ìƒì„± ì¤‘...');
    
    const bookings = [];
    const statuses = ['pending', 'confirmed', 'completed', 'cancelled'];
    const times = ['09:00', '10:00', '11:00', '14:00', '15:00', '16:00', '17:00'];
    
    for (let i = 0; i < 50; i++) {
      const daysAgo = Math.floor(i / 7);
      const status = statuses[Math.floor(Math.random() * statuses.length)];
      const time = times[Math.floor(Math.random() * times.length)];
      
      bookings.push({
        userId: `U${String(Math.floor(Math.random() * 1000)).padStart(4, '0')}`, // ëœë¤ ì‚¬ìš©ì
        petId: `PET${String(Math.floor(Math.random() * 1000)).padStart(4, '0')}`, // ëœë¤ í«
        clinicId: clinicId,
        hospitalName: 'í–‰ë³µë™ë¬¼ë³‘ì›',
        date: getDate(daysAgo),
        time: time,
        status: status,
        reason: ['ì˜ˆë°©ì ‘ì¢…', 'ì •ê¸°ê²€ì§„', 'ì¦ìƒ ì§„ë£Œ', 'ìˆ˜ìˆ  ìƒë‹´'][Math.floor(Math.random() * 4)],
        createdAt: getDate(daysAgo + 1),
        updatedAt: getDate(daysAgo)
      });
    }

    const bookingIds = [];
    for (const booking of bookings) {
      const ref = await db.collection('bookings').add(booking);
      bookingIds.push(ref.id);
    }
    console.log(`   âœ… ì˜ˆì•½ ê¸°ë¡ 50ê°œ ìƒì„± ì™„ë£Œ`);

    // 3. ì§„ë£Œ ê²°ê³¼ ìƒì„± (~40ê°œ, ì™„ë£Œëœ ì˜ˆì•½ ê¸°ì¤€)
    console.log('\nğŸ“‹ ì§„ë£Œ ê²°ê³¼ ìƒì„± ì¤‘...');
    
    const completedBookings = bookings.filter(b => b.status === 'completed').slice(0, 40);
    const clinicResults = [];
    
    for (let i = 0; i < completedBookings.length; i++) {
      const booking = completedBookings[i];
      clinicResults.push({
        userId: booking.userId,
        petId: booking.petId,
        clinicId: clinicId,
        hospitalName: 'í–‰ë³µë™ë¬¼ë³‘ì›',
        bookingId: bookingIds[bookings.indexOf(booking)],
        diagnosis: ['í”¼ë¶€ì—¼', 'ì†Œí™”ë¶ˆëŸ‰', 'í˜¸í¡ê¸° ê°ì—¼', 'ì¹˜ì•„ ë¬¸ì œ', 'ì •ìƒ'][Math.floor(Math.random() * 5)],
        treatment: 'ì²˜ë°©ì•½ ë³µìš© ë° ê²½ê³¼ ê´€ì°°',
        prescription: ['í•­ìƒì œ', 'ì†Œí™”ì œ', 'í•­íˆìŠ¤íƒ€ë¯¼ì œ', 'ì§„í†µì œ'][Math.floor(Math.random() * 4)],
        notes: 'ì •ê¸° ê²€ì§„ ì™„ë£Œ',
        createdAt: booking.date,
        updatedAt: booking.date
      });
    }

    for (const result of clinicResults) {
      await db.collection('clinicResults').add(result);
    }
    console.log(`   âœ… ì§„ë£Œ ê²°ê³¼ ${clinicResults.length}ê°œ ìƒì„± ì™„ë£Œ`);

    // 4. ë“±ë¡ í™˜ì ìƒì„± (10~15ë§ˆë¦¬)
    console.log('\nğŸ‘¥ ë“±ë¡ í™˜ì ìƒì„± ì¤‘...');
    
    const patientCount = 12; // 10~15 ì¤‘ê°„ê°’
    const patients = [];
    
    for (let i = 0; i < patientCount; i++) {
      const species = ['dog', 'cat'][Math.floor(Math.random() * 2)];
      const breeds = species === 'dog' 
        ? ['ë§í‹°ì¦ˆ', 'í‘¸ë“¤', 'ë¹„ê¸€', 'ê³¨ë“ ë¦¬íŠ¸ë¦¬ë²„']
        : ['í˜ë¥´ì‹œì•ˆ', 'ìƒ´', 'ëŸ¬ì‹œì•ˆë¸”ë£¨', 'ì½”ë¦¬ì•ˆìˆí—¤ì–´'];
      
      patients.push({
        clinicId: clinicId,
        clinicName: 'í–‰ë³µë™ë¬¼ë³‘ì›',
        petId: `PET${String(i + 1).padStart(4, '0')}`,
        petName: ['ì´ˆì½”', 'ë‚˜ë¹„', 'ë£¨ì´', 'ë¯¸ë¯¸', 'ë½€ì‚', 'ì¹˜ì¦ˆ', 'ì½”ì½”', 'ë³„ì´', 'í•˜ëŠ˜ì´', 'êµ¬ë¦„ì´'][i],
        species: species,
        speciesLabelKo: species === 'dog' ? 'ê°•ì•„ì§€' : 'ê³ ì–‘ì´',
        breed: breeds[Math.floor(Math.random() * breeds.length)],
        birthDate: getDate(365 * (2 + Math.floor(Math.random() * 5))),
        ownerUserId: `U${String(i + 1).padStart(4, '0')}`,
        visitCount: Math.floor(Math.random() * 5) + 1,
        lastVisitDate: getDate(Math.floor(Math.random() * 30)),
        lastDiagnosis: ['ì •ìƒ', 'í”¼ë¶€ì—¼', 'ì†Œí™”ë¶ˆëŸ‰'][Math.floor(Math.random() * 3)],
        lastTriageLevel: ['low', 'medium', 'high'][Math.floor(Math.random() * 3)],
        lastWeightKg: (2 + Math.random() * 5).toFixed(1),
        createdAt: getDate(30 + i),
        updatedAt: getDate(Math.floor(Math.random() * 30))
      });
    }

    for (const patient of patients) {
      await db.collection('clinicPatients').add(patient);
    }
    console.log(`   âœ… ë“±ë¡ í™˜ì ${patientCount}ë§ˆë¦¬ ìƒì„± ì™„ë£Œ`);

    console.log('\nâœ… ë³‘ì› ê³„ì • ë°ì´í„° ìƒì„± ì™„ë£Œ!');
    return {
      success: true,
      clinicId: clinicId,
      bookings: 50,
      clinicResults: clinicResults.length,
      patients: patientCount
    };
  } catch (error) {
    console.error('âŒ ë³‘ì› ë°ì´í„° ìƒì„± ì˜¤ë¥˜:', error);
    throw error;
  }
}

/**
 * ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜
 */
async function main() {
  const args = process.argv.slice(2);
  
  if (args.length < 2) {
    console.log('ì‚¬ìš©ë²•: node scripts/seedTestData.js <ë³´í˜¸ìUID> <ë³‘ì›UID>');
    console.log('\nì˜ˆì‹œ:');
    console.log('  node scripts/seedTestData.js abc123 xyz789');
    console.log('\në˜ëŠ” ê°ê° ì‹¤í–‰:');
    console.log('  node scripts/seedTestData.js --guardian <ë³´í˜¸ìUID>');
    console.log('  node scripts/seedTestData.js --clinic <ë³‘ì›UID>');
    process.exit(1);
  }

  try {
    if (args[0] === '--guardian') {
      const guardianUid = args[1];
      const userDoc = await db.collection('users').doc(guardianUid).get();
      if (!userDoc.exists()) {
        console.error(`âŒ ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${guardianUid}`);
        process.exit(1);
      }
      const email = userDoc.data().email || 'unknown@example.com';
      await seedGuardianData(guardianUid, email);
    } else if (args[0] === '--clinic') {
      const clinicUid = args[1];
      const userDoc = await db.collection('users').doc(clinicUid).get();
      if (!userDoc.exists()) {
        console.error(`âŒ ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${clinicUid}`);
        process.exit(1);
      }
      const email = userDoc.data().email || 'unknown@example.com';
      await seedClinicData(clinicUid, email);
    } else {
      const guardianUid = args[0];
      const clinicUid = args[1];
      
      // ì‚¬ìš©ì í™•ì¸
      const [guardianDoc, clinicDoc] = await Promise.all([
        db.collection('users').doc(guardianUid).get(),
        db.collection('users').doc(clinicUid).get()
      ]);
      
      if (!guardianDoc.exists()) {
        console.error(`âŒ ë³´í˜¸ì ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${guardianUid}`);
        process.exit(1);
      }
      if (!clinicDoc.exists()) {
        console.error(`âŒ ë³‘ì› ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${clinicUid}`);
        process.exit(1);
      }
      
      const guardianEmail = guardianDoc.data().email || 'unknown@example.com';
      const clinicEmail = clinicDoc.data().email || 'unknown@example.com';
      
      await seedGuardianData(guardianUid, guardianEmail);
      await seedClinicData(clinicUid, clinicEmail);
    }
    
    console.log('\nğŸ‰ ëª¨ë“  ì‹œë“œ ë°ì´í„° ìƒì„± ì™„ë£Œ!');
    process.exit(0);
  } catch (error) {
    console.error('\nâŒ ì˜¤ë¥˜:', error);
    process.exit(1);
  }
}

main();

